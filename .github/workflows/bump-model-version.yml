name: Bump Kraken.Models on master

on:
  push:
    branches: [ master ]
    paths:
      - 'src/Kraken.Models/**'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  packages: write

jobs:
  bump:
    # Do not run on the bump commit itself
    if: ${{ !contains(github.event.head_commit.message, '[skip bump]') }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '9.0.x'

      - name: Set project path
        id: vars
        run: echo "project=src/Kraken.Models/Kraken.Models.csproj" >> $GITHUB_OUTPUT

      - name: Bump version (patch)
        id: bump
        shell: pwsh
        run: |
          $proj = '${{ steps.vars.outputs.project }}'
          if (-not (Test-Path $proj)) { throw "Project file not found: $proj" }

          [xml]$xml = Get-Content $proj
          $pg = $xml.Project.PropertyGroup | Where-Object { $_.Version }
          if (-not $pg) { $pg = $xml.Project.PropertyGroup[0]; $pg.AppendChild($xml.CreateElement('Version')) | Out-Null }

          $current = $pg.Version.'#text'
          if ([string]::IsNullOrWhiteSpace($current)) { $current = '0.1.0' }

          $parts = $current.Split('.')
          while ($parts.Length -lt 3) { $parts += '0' }
          $patch = [int]$parts[2] + 1
          $newVersion = "$($parts[0]).$($parts[1]).$patch"

          if ($newVersion -ne $current) {
            $pg.Version = $newVersion
            $xml.Save($proj)
            "new_version=$newVersion" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
            "changed=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
            Write-Host "Bumped $current -> $newVersion"
          } else {
            "new_version=$current" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
            "changed=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
            Write-Host "No bump necessary (already $current)"
          }

      - name: Commit bump to master (mark commit to skip re-bump)
        if: steps.bump.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ steps.vars.outputs.project }}
          git commit -m "chore(models): bump version to ${{ steps.bump.outputs.new_version }} [skip bump]"
          git push origin HEAD

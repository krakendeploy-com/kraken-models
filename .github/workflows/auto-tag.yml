# .github/workflows/auto-tag.yml
name: Auto tag on master merge
on:
  push:
    branches: [ master ]
    paths:
      - 'src/Kraken.Models/**'

permissions:
  contents: write

jobs:
  tag:
    if: ${{ !startsWith(github.ref, 'refs/tags/') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine next version (patch bump)
        id: ver
        shell: bash
        run: |
          latest=$(git tag -l 'v*.*.*' --sort=-v:refname | head -n1)
          if [ -z "$latest" ]; then
            next="v1.0.0"  # first release default
          else
            IFS='.' read -r major minor patch <<<"${latest#v}"
            next="v${major}.${minor}.$((patch+1))"
          fi
          echo "next=$next" >> "$GITHUB_OUTPUT"
          echo "Next version: $next"

      - name: Create and push tag
        shell: bash
        run: |
          # set tagger identity
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          tag="${{ steps.ver.outputs.next }}"

          # safety: donâ€™t recreate if it already exists locally or remotely
          if git rev-parse -q --verify "refs/tags/$tag" >/dev/null; then
            echo "Tag $tag already exists locally; skipping."
            exit 0
          fi
          if git ls-remote --tags origin "refs/tags/$tag" | grep -q "$tag$"; then
            echo "Tag $tag already exists on origin; skipping."
            exit 0
          fi

          git tag -a "$tag" -m "Release $tag"
          git push origin "$tag"
